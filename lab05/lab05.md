# Практика 5. Прикладной уровень

## Программирование сокетов.

### A. Почта и SMTP (7 баллов)

### 1. Почтовый клиент (2 балла)
Напишите программу для отправки электронной почты получателю, адрес
которого задается параметром. Адрес отправителя может быть постоянным. Программа
должна поддерживать два формата сообщений: **txt** и **html**. Используйте готовые
библиотеки для работы с почтой, т.е. в этом задании **не** предполагается общение с smtp
сервером через сокеты напрямую.

Приложите скриншоты полученных сообщений (для обоих форматов).

#### Демонстрация работы
Не попал на сервер, хоть и сгенерировал пароль. Возможно, проблемы с самим сервером
![img.png](img.png)

### 2. SMTP-клиент (3 балла)
Разработайте простой почтовый клиент, который отправляет текстовые сообщения
электронной почты произвольному получателю. Программа должна соединиться с
почтовым сервером, используя протокол SMTP, и передать ему сообщение.
Не используйте встроенные методы для отправки почты, которые есть в большинстве
современных платформ. Вместо этого реализуйте свое решение на сокетах с передачей
сообщений почтовому серверу.

Сделайте скриншоты полученных сообщений.

#### Демонстрация работы
todo

### 3. SMTP-клиент: бинарные данные (2 балла)
Модифицируйте ваш SMTP-клиент из предыдущего задания так, чтобы теперь он мог
отправлять письма с изображениями (бинарными данными).

Сделайте скриншот, подтверждающий получение почтового сообщения с картинкой.

#### Демонстрация работы
todo

---

_Многие почтовые серверы используют ssl, что может вызвать трудности при работе с ними из
ваших приложений. Можете использовать для тестов smtp сервер СПбГУ: mail.spbu.ru, 25_

### Б. Удаленный запуск команд (3 балла)
Напишите программу для запуска команд (или приложений) на удаленном хосте с помощью TCP сокетов.

Например, вы можете с клиента дать команду серверу запустить приложение Калькулятор или
Paint (на стороне сервера). Или запустить консольное приложение/утилиту с указанными
параметрами. Однако запущенное приложение **должно** выводить какую-либо информацию на
консоль или передавать свой статус после запуска, который должен быть отправлен обратно
клиенту. Продемонстрируйте работу вашей программы, приложив скриншот.

Например, удаленно запускается команда `ping yandex.ru`. Результат этой команды (запущенной на
сервере) отправляется обратно клиенту.

#### Демонстрация работы
![img_1.png](img_1.png)

### В. Широковещательная рассылка через UDP (2 балла)
Реализуйте сервер (веб-службу) и клиента с использованием интерфейса Socket API, которая:
- работает по протоколу UDP
- каждую секунду рассылает широковещательно всем клиентам свое текущее время
- клиент службы выводит на консоль сообщаемое ему время

#### Демонстрация работы
![img_2.png](img_2.png)

## Задачи

### Задача 1 (2 балла)
Рассмотрим короткую, $10$-метровую линию связи, по которой отправитель может передавать
данные со скоростью $150$ бит/с в обоих направлениях. Предположим, что пакеты, содержащие
данные, имеют размер $100000$ бит, а пакеты, содержащие только управляющую информацию
(например, флаг подтверждения или информацию рукопожатия) – $200$ бит. Предположим, что у
нас $10$ параллельных соединений, и каждому предоставлено $1/10$ полосы пропускания канала
связи. Также допустим, что используется протокол HTTP, и предположим, что каждый
загруженный объект имеет размер $100$ Кбит, и что исходный объект содержит $10$ ссылок на другие
объекты того же отправителя. Будем считать, что скорость распространения сигнала равна
скорости света ($300 \cdot 10^6$ м/с).
1. Вычислите общее время, необходимое для получения всех объектов при параллельных
непостоянных HTTP-соединениях
2. Вычислите общее время для постоянных HTTP-соединений. Ожидается ли существенное
преимущество по сравнению со случаем непостоянного соединения?

#### Решение
## Дано
- Длина линии: 10 м
- Скорость передачи: 150 бит/с (15 бит/с на соединение)
- Размер объекта: 100000 бит
- Управляющий пакет: 200 бит
- Соединений: 10
- Скорость света: $300 \times 10^6$ м/с
- Объектов: 11 (1 исходный + 10 связанных)

## Общие параметры
- Задержка распространения: $t_{\text{prop}} = \frac{10}{300 \times 10^6} \approx 3.33 \times 10^{-8} \, \text{с}$ (пренебрежимо мало)
- Время передачи управляющего пакета: $t_{\text{trans}} = \frac{200}{15} = \frac{40}{3} \approx 13.333 \, \text{с}$
- Время передачи объекта: $t_{\text{data}} = \frac{100000}{15} = \frac{20000}{3} \approx 6666.667 \, \text{с}$

## 1. Непостоянные HTTP-соединения
- Время на объект: $T_{\text{obj}} = 4 t_{\text{trans}} + t_{\text{data}} = 4 \times \frac{40}{3} + \frac{20000}{3} = 6720 \, \text{с}$ (TCP-рукопожатие + запрос + данные)
- T1 (исходный объект): 6720 с
- T2 (10 объектов параллельно): 6720 с
- **Общее время**: $6720 + 6720 = 13440 \, \text{с}$

## 2. Постоянные HTTP-соединения
- Установление 10 соединений: $3 t_{\text{trans}} = 3 \times \frac{40}{3} = 40 \, \text{с}$
- Время на объект: $t_{\text{trans}} + t_{\text{data}} = \frac{40}{3} + \frac{20000}{3} \approx 6713.333 \, \text{с}$
- T1 (исходный): 6713.333 с
- T2 (10 объектов параллельно): 6713.333 с
- **Общее время**: $40 + 6713.333 + 6713.333 = 13400 \, \text{с}$

## Вывод
- Непостоянные: **13440 с**
- Постоянные: **13400 с**
- Разница: $13440 - 13400 = 40 \, \text{с}$ — **преимущество несущественно**, так как время передачи данных доминирует.

### Задача 2 (3 балла)
Рассмотрим раздачу файла размером $F = 15$ Гбит $N$ пирам. Сервер имеет скорость отдачи $u_s = 30$
Мбит/с, а каждый узел имеет скорость загрузки $d_i = 2$ Мбит/с и скорость отдачи $u$. Для $N = 10$, $100$
и $1000$ и для $u = 300$ Кбит/с, $700$ Кбит/с и $2$ Мбит/с подготовьте график минимального времени
раздачи для всех сочетаний $N$ и $u$ для вариантов клиент-серверной и одноранговой раздачи.

#### Решение
#### Дано
- Размер файла: $F = 15 \, \text{Гбит} = 15 \times 1000 = 15000 \, \text{Мбит}$
- Скорость отдачи сервера: $u_s = 30 \, \text{Мбит/с}$
- Скорость загрузки пира: $d_i = 2 \, \text{Мбит/с}$
- Число пиров: $N = 10, 100, 1000$
- Скорость отдачи пира: $u = 0.3, 0.7, 2 \, \text{Мбит/с}$

#### 1. Клиент-серверная раздача
Сервер отправляет файл каждому пиру отдельно. Минимальное время определяется как максимум между временем работы сервера и временем загрузки пира:
\[
T_{\text{cs}} = \max\left( \frac{F \cdot N}{u_s}, \frac{F}{d_i} \right)
\]
- $\frac{F}{d_i} = \frac{15000}{2} = 7500 \, \text{с}$ — фиксировано для всех $N$.
- $\frac{F \cdot N}{u_s} = \frac{15000 \cdot N}{30} = 500 \cdot N \, \text{с}$.

#### 2. Одноранговая (P2P) раздача
Пиры обмениваются данными между собой. Минимальное время:
$$
T_{\text{p2p}} = \max\left( \frac{F}{u_s}, \frac{F}{d_i}, \frac{F \cdot N}{u_s + N \cdot u} \right)
$$
- $\frac{F}{u_s} = \frac{15000}{30} = 500 \, \text{с}$
- $\frac{F}{d_i} = 7500 \, \text{с}$
- $\frac{F \cdot N}{u_s + N \cdot u}$ зависит от $N$ и $u$.

#### Визуализация
Код для визуализации представлен в **problem2visualise.py**

![problem2figure.png](problem2figure.png)

### Задача 3 (3 балла)
Рассмотрим клиент-серверную раздачу файла размером $F$ бит $N$ пирам, при которой сервер
способен отдавать одновременно данные множеству пиров – каждому с различной скоростью,
но общая скорость отдачи при этом не превышает значения $u_s$. Схема раздачи непрерывная.
1. Предположим, что $\dfrac{u_s}{N} \le d_{min}$.
   При какой схеме общее время раздачи будет составлять $\dfrac{N F}{u_s}$?
2. Предположим, что $\dfrac{u_s}{N} \ge d_{min}$. 
   При какой схеме общее время раздачи будет составлять  $\dfrac{F}{d_{min}}$?
3. Докажите, что минимальное время раздачи описывается формулой $\max\left(\dfrac{N F}{u_s}, \dfrac{F}{d_{min}}\right)$?

#### Решение
#### 1. Случай $\dfrac{u_s}{N} \leq d_{\text{min}}$: Время раздачи $\dfrac{N F}{u_s}$

Если $\dfrac{u_s}{N} \leq d_{\text{min}}$, сервер может распределить свою скорость $u_s$ поровну между всеми $N$ пирами, выделяя каждому $\dfrac{u_s}{N}$, и это не превышает $d_{\text{min}}$.

#### Схема:
- Сервер делит $u_s$ на $N$ пиров, каждому — скорость $\dfrac{u_s}{N}$.
- Общая скорость сервера: $N \cdot \dfrac{u_s}{N} = u_s$.
- Общий объем данных: $N \cdot F$ бит.
- Время раздачи:
  $$
  T = \frac{N \cdot F}{u_s}
  $$

Так как $\dfrac{u_s}{N} \leq d_{\text{min}} \leq d_i$, все пиры могут принимать данные с этой скоростью. Таким образом, при равномерном распределении скорости время раздачи составляет $\dfrac{N F}{u_s}$.

---

#### 2. Случай $\dfrac{u_s}{N} \geq d_{\text{min}}$: Время раздачи $\dfrac{F}{d_{\text{min}}}$

Если $\dfrac{u_s}{N} \geq d_{\text{min}}$, равномерное распределение $\dfrac{u_s}{N}$ может превысить $d_{\text{min}}$, ограничивая самого медленного пира.

#### Схема:
- Самый медленный пир (с $d_i = d_{\text{min}}$) загружает $F$ бит со скоростью $d_{\text{min}}$.
- Время для него:
  $$
  T = \frac{F}{d_{\text{min}}}
  $$
- Сервер распределяет $u_s$ так, чтобы этот пир получил $d_{\text{min}}$, а остальным — скорости $\geq d_{\text{min}}$, не превышая $u_s$.
- Условие $u_s \geq N \cdot d_{\text{min}}$ гарантирует, что сервер может обеспечить $d_{\text{min}}$ каждому пиру.

Раздача завершается, когда самый медленный пир получит файл, то есть за $\dfrac{F}{d_{\text{min}}}$.

---

#### 3. Доказательство минимального времени $\max\left(\dfrac{N F}{u_s}, \dfrac{F}{d_{\text{min}}}\right)$

Минимальное время определяется двумя ограничениями:
- **Сервер**: Передача $N \cdot F$ бит со скоростью $u_s$ требует:
  $$
  \frac{N F}{u_s}
  $$
- **Пир**: Самый медленный пир загружает $F$ бит со скоростью $d_{\text{min}}$ за:
  $$
  \frac{F}{d_{\text{min}}}
  $$

Общее время $T$ не может быть меньше ни одного из них:
- Если $T < \dfrac{N F}{u_s}$, сервер не успеет передать $N \cdot F$ бит.
- Если $T < \dfrac{F}{d_{\text{min}}}$, самый медленный пир не получит файл.

#### Доказательство:
- **$\dfrac{u_s}{N} \leq d_{\text{min}}$** (или $\dfrac{N F}{u_s} \geq \dfrac{F}{d_{\text{min}}}$):
   - Из п.1: $T = \dfrac{N F}{u_s}$.
   - $\max\left(\dfrac{N F}{u_s}, \dfrac{F}{d_{\text{min}}}\right) = \dfrac{N F}{u_s}$ — совпадает.
- **$\dfrac{u_s}{N} \geq d_{\text{min}}$** (или $\dfrac{N F}{u_s} \leq \dfrac{F}{d_{\text{min}}}$):
   - Из п.2: $T = \dfrac{F}{d_{\text{min}}}$.
   - $\max\left(\dfrac{N F}{u_s}, \dfrac{F}{d_{\text{min}}}\right) = \dfrac{F}{d_{\text{min}}}$ — совпадает.

Формула $T = \max\left(\dfrac{N F}{u_s}, \dfrac{F}{d_{\text{min}}}\right)$ - достижима и отражает минимальное время раздачи.
